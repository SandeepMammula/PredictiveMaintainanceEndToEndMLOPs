name: CD - Deploy to GCP

on:
  workflow_run:
    workflows: ["CI - Test and Build"]
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
    
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
    
    - name: Configure Docker for GCR
      run: |
        gcloud auth configure-docker us-docker.pkg.dev
    
    - name: Build and Push Docker image
      run: |
        docker build -t us-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/turbofan-api:${{ github.sha }} .
        docker push us-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/turbofan-api:${{ github.sha }}
        docker tag us-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/turbofan-api:${{ github.sha }} \
                   us-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/turbofan-api:latest
        docker push us-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/turbofan-api:latest
    
    - name: Deploy to GKE
      run: |
        gcloud container clusters get-credentials ${{ secrets.GKE_CLUSTER_NAME }} \
          --zone ${{ secrets.GKE_ZONE }}
        
        kubectl set image deployment/turbofan-api \
          turbofan-api=us-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/turbofan-api:${{ github.sha }}
        
        kubectl rollout status deployment/turbofan-api
    
    - name: Deployment complete
      run: echo "âœ… Deployed to GKE"

# name: CD - Deploy to GCP

# on:
#   workflow_run:
#     workflows: ["CI - Test and Build"]
#     types:
#       - completed

# jobs:
#   deploy:
#     if: ${{ github.event.workflow_run.conclusion == 'success' }}
#     runs-on: ubuntu-latest

#     steps:
#     - uses: actions/checkout@v3

#     - uses: google-github-actions/auth@v2
#       with:
#         credentials_json: ${{ secrets.GCP_SA_KEY }}

#     - uses: google-github-actions/setup-gcloud@v2

#     - run: gcloud auth configure-docker us-docker.pkg.dev --quiet

#     - run: |
#         docker build -t us-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/ml-images/turbofan-api:${{ github.sha }} .
#         docker push us-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/ml-images/turbofan-api:${{ github.sha }}

#     - run: |
#         gcloud container clusters get-credentials ${{ secrets.GKE_CLUSTER_NAME }} \
#           --zone ${{ secrets.GKE_ZONE }}

#         kubectl set image deployment/turbofan-api \
#           turbofan-api=us-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/ml-images/turbofan-api:${{ github.sha }}

#         kubectl rollout status deployment/turbofan-api
